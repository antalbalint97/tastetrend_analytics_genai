# Infrastructure Decisions – TasteTrend ETL (GenAI POC)

## Overview
This document records the infrastructure-related design decisions, trade-offs, and roadmap for the **TasteTrend ETL pipeline** deployed in AWS.

The objective is to ensure clear separation between **data standardization (documented in `data_exploration.md`)** and **infrastructure setup** for operating the ETL at scale.

---

## AWS Lambda Setup
- **Runtime:** Python 3.11  
- **Handler:** `api_handler.lambda_handler`  
- **Memory:** 1024 MB (chosen for pandas performance headroom).  
- **Timeout:** 30s (sufficient for processing single review files; subject to increase if needed).  
- **Ephemeral Storage:** `/tmp` directory used for staging raw + processed files during execution.  

**Trade-offs:**
- ✅ Serverless, no infrastructure to maintain.  
- ✅ Cheap for POC workloads.  
- ❌ Hard runtime limits (15 min, /tmp size, memory).  
- **Mitigation:** Batch processing not supported in MVP; future: consider step functions or container-based approach if limits reached.

---

## AWS SDK (boto3)
- Chosen over AWS CLI calls inside Lambda for **programmatic control**.  
- Used for:
  - `download_file` → get raw file from S3 into `/tmp`.  
  - `upload_file` → push processed parquet into processed bucket.  

---

## Deployment Strategy
- **Current:**  
  - Source packaged as `.zip` and uploaded to the **artifacts bucket**.  
  - Lambda updated via `aws lambda update-function-code`.  
  - Versions tracked manually with suffixes (`etl-0.4.zip`, `etl-0.5.zip`, …).  

- **Rejected:**  
  - Docker container packaging → dropped after experimentation, as `.zip` packaging was simpler and sufficient for Python+pandas with AWS SDK Pandas layer.  

- **Future:**  
  - Automate ZIP versioning & deployment with IaC pipeline (Terraform / CDK).  
  - Enable Lambda versions/aliases for production vs dev promotion.

---

## IAM Design
- **Lambda execution role:** `tastetrend-dev-etl-role`  
  - Permissions:  
    - Read from `tastetrend-dev-raw-<account_id>`  
    - Write to `tastetrend-dev-processed-<account_id>`  
    - Read/write to `tastetrend-dev-artifacts-<account_id>`  
  - Limited to S3 + CloudWatch logging for principle of least privilege.

- **Trade-offs:**  
  - ✅ Clear separation of buckets + roles = easier auditing.  
  - ❌ Slightly more verbose IAM policy.  
  - **Mitigation:** Scoped policies attached only to Lambda role.

---

## S3 Buckets
- **Artifacts** (`tastetrend-dev-artifacts-<account_id>`)  
  Stores Lambda deployment ZIPs and dependency layers.  

- **Raw** (`tastetrend-dev-raw-<account_id>`)  
  Ingested unprocessed files.  

- **Processed** (`tastetrend-dev-processed-<account_id>`)  
  Output parquet files generated by ETL.  

**Trade-offs:**  
- ✅ Follows data lake best practices (raw → processed → curated).  
- ✅ Debuggable: can inspect raw and processed independently.  
- ❌ More buckets to manage.  
- **Mitigation:** Standardized naming and tagging.  

---

## Versioning Strategy
- **Lambda code:** versioned via S3 object name suffix (`etl-0.7.zip`).  
- **Data outputs:** processed parquet stored under `processed/processed_<filename>.parquet`.  
- **Trade-offs:**  
  - ✅ Simple manual tracking for POC.  
  - ❌ Lacks automated rollback and alias support.  
  - **Future:** Use Lambda versions + aliases, and S3 versioning enabled on buckets for production.  

---

## IaC (Infrastructure as Code)
- **Modules:** Each bucket and Lambda defined as a Terraform module.  
- **Locals:** Standard naming pattern `tastetrend-dev-*`.  
- **Future expansion:**  
  - Add CI/CD pipeline for Lambda packaging and deployment.  
  - Add monitoring via CloudWatch metrics & alarms.  
  - Introduce Step Functions for batch orchestration.  

---

## Future MVP Roadmap
- Batch ETL (multi-file triggers via S3 event).  
- CI/CD with automated packaging + deployment.  
- Automated validation pipeline integrated with Lambda.  
- Promotion of dev → staging → prod via Lambda aliases.  
- Optional: Migrate to container-based Lambda if pandas workloads exceed current limits.  

---

✅ This document captures **infrastructure and deployment decisions**.  
Schema and transformation details are recorded separately in **`data_exploration.md`**.
